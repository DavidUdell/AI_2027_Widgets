<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 2027 Widgets Demo</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            color: #333;
        }

        h1 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        h2 {
            color: #2c3e50;
            margin-top: 40px;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .widget-container {
            display: block;
            text-align: center;
            margin: 20px auto;
            padding: 30px;
            width: 100%;
            min-height: 600px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #fafafa;
            box-sizing: border-box;
        }

        .widget-container h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #2c3e50;
            font-size: 20px;
        }

        .widget-container h2 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #007bff;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
            font-size: 24px;
            text-align: left;
        }

        .widget-container p {
            text-align: left;
        }

        .widget-canvas {
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #f8f9fa;
            cursor: crosshair;
            max-width: 100%;
            display: block;
            margin: 0 auto;
        }

        .reference-widget-canvas {
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #f8f9fa;
            max-width: 100%;
            display: block;
            margin: 0 auto;
        }

        .highlight {
            background: #fff3cd;
            padding: 2px 4px;
            border-radius: 3px;
        }

        .instructions {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 12px;
            margin: 20px 0;
            border-radius: 4px;
        }

        .reference-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 30px;
            margin: 40px 0;
            box-sizing: border-box;
        }

        .reference-section h2 {
            margin-top: 0;
            color: #28a745;
            border-bottom: 2px solid #28a745;
            padding-bottom: 10px;
        }

        .ground-truth-section h2 {
            margin-top: 0;
            color: #dc3545;
            border-bottom: 2px solid #dc3545;
            padding-bottom: 10px;
        }

        /* Remove spinner arrows from number input */
        #total-mass::-webkit-outer-spin-button,
        #total-mass::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        #total-mass[type=number] {
            appearance: textfield;
        }

        /* Enhanced number input styling */
        .number-input-container {
            display: inline-flex;
            align-items: center;
            position: relative;
        }

        .number-input {
            padding: 4px 6px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 30px;
            text-align: center;
            font-size: 14px;
            transition: border-color 0.2s ease;
        }

        .number-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        .number-input.invalid {
            border-color: #dc3545;
            background-color: #fff5f5;
        }

        .input-feedback {
            position: absolute;
            top: 100%;
            left: 40%;
            transform: translateX(-50%);
            font-size: 11px;
            color: #6c757d;
            white-space: nowrap;
            margin-top: 0px;
            text-align: center;
            width: 100%;
        }

        .input-feedback.error {
            color: #dc3545;
        }

        .input-feedback.success {
            color: #28a745;
        }
    </style>
</head>
<body>
    <h1>AI 2027 Widgets Demo</h1>

    <p>
        Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod
        tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim
        veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea
        commodo consequat.
    </p>

    <p>
        Duis aute irure dolor in reprehenderit in voluptate velit esse cillum
        dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non
        proident, sunt in culpa qui officia deserunt mollit anim id est
        laborum.
    </p>

    <div class="reference-section">
        <h2>Our AGI Timelines</h2>
        <p>
            Our distribution over quarters in which AGI might be developed is
            shown here:
        </p>
        <div id="reference-widget"></div>
        <p>
            The total mass of the distribution is 75%, which is our subjective
            probability that AGI will be developed by 2040. Our distribution
            peaks in Q1 of 2033, with a 3% probability that AGI will be
            developed in that particular quarter.
        </p>
    </div>

    <p>
        Sed ut perspiciatis unde omnis iste natus error sit voluptatem
        accusantium doloremque laudantium, totam rem aperiam, eaque ipsa quae
        ab illo inventore veritatis et quasi architecto beatae vitae dicta sunt
        explicabo.
    </p>

    <p>
        Nemo enim ipsam voluptatem quia voluptas sit aspernatur aut odit aut
        fugit, sed quia consequuntur magni dolores eos qui ratione voluptatem
        sequi nesciunt. Neque porro quisquam est, qui dolorem ipsum quia dolor
        sit amet, consectetur, adipisci velit, sed quia non numquam eius modi
        tempora incidunt ut labore et dolore magnam aliquam quaerat voluptatem.
    </p>

    <div class="widget-container">
        <h2>Your AGI Timelines</h2>
        <div class="instructions">
            <strong>Instructions:</strong> Set your total subjective
            probability on AGI being developed by the year 2040 using the box
            below. Click and drag in the interactive widget to change the
            distribution of that probability over quarters.
        </div>
            <div style="margin-bottom: 15px; text-align: center;">
            <label for="total-mass" style="font-weight: bold; margin-right:
            10px;">Probability AGI by 2040:</label>
            <div class="number-input-container">
                <input type="text" id="total-mass" value="50" 
                       class="number-input"
                       inputmode="numeric" pattern="[0-9]*">
                <span style="margin-left: 5px;">%</span>
                <div id="input-feedback" class="input-feedback"></div>
            </div>
        </div>
        <div id="distribution-widget"></div>
    </div>

    <p>
        Ut enim ad minima veniam, quis nostrum exercitationem ullam corporis
        suscipit laboriosam, nisi ut aliquid ex ea commodi consequatur? Quis
        autem vel eum iure reprehenderit qui in ea voluptate velit esse quam
        nihil molestiae consequatur, vel illum qui dolorem eum fugiat quo
        voluptas nulla pariatur?
    </p>

    <p>
        Vivamus congue mauris neque, sollicitudin porttitor ipsum tempus
        eleifend. Interdum et malesuada fames ac ante ipsum primis in faucibus.
        Mauris molestie sodales commodo. Nunc ultrices mauris magna, non
        condimentum tellus varius a. Praesent hendrerit, massa ac iaculis
        scelerisque, risus est maximus risus, sed pulvinar quam lorem at metus.
        Curabitur ante diam, laoreet laoreet auctor non, sollicitudin ac velit.
        Quisque pretium nunc magna, ac ornare purus pharetra eget. Orci varius
        natoque penatibus et magnis dis parturient montes, nascetur ridiculus
        mus. Nullam in arcu pellentesque, finibus tellus varius, facilisis
        dolor. Curabitur tempor felis vitae turpis tristique vehicula. Praesent
        quis magna in metus mattis imperdiet et rutrum libero. Morbi leo dui,
        rutrum eget cursus eu, rhoncus vel diam. Aenean molestie pharetra
        imperdiet. Quisque ultrices, enim sit amet viverra efficitur, tellus
        augue interdum odio, in viverra augue eros sit amet tellus.
    </p>

    <p>
        Quisque vel aliquet ex. Donec dui lacus, faucibus a nisi id, vulputate
        sagittis lorem. Aenean pretium purus in lacus scelerisque luctus.
        Pellentesque efficitur in magna in malesuada. Nunc vestibulum interdum
        nunc eget dictum. Mauris ullamcorper, diam ut pretium tincidunt, diam
        mi tempus dui, id scelerisque turpis augue id dui. Donec euismod, leo
        porta ultrices dictum, augue nibh rhoncus quam, ac volutpat odio ante
        id augue.
    </p>

    <p>
        Curabitur venenatis, leo sit amet consequat porta, odio turpis
        tincidunt ligula, condimentum auctor lacus velit ut lectus. Sed in
        massa non justo fringilla rhoncus dapibus quis est. Donec tincidunt
        magna turpis, ac condimentum purus vulputate et. Pellentesque risus
        nisi, pulvinar ut rhoncus sit amet, interdum at felis. Fusce ligula
        massa, ornare nec ultrices vel, fermentum varius metus. Fusce sed
        placerat erat. Pellentesque habitant morbi tristique senectus et netus
        et malesuada fames ac turpis egestas. Maecenas tortor eros, maximus non
        tincidunt nec, accumsan et nunc. Mauris velit nisl, venenatis vel
        fermentum ut, gravida et odio. Donec et auctor eros, vitae scelerisque
        augue. Sed euismod tellus vel urna hendrerit, vitae vulputate augue
        venenatis. Nunc rhoncus, massa a facilisis egestas, ligula felis rutrum
        lorem, a egestas nisl nisi sed enim. Fusce non dapibus elit, nec
        consequat augue.        
    </p>

    <div class="reference-section ground-truth-section">
        <h2>Ground Truth AGI Timeline</h2>
        <p>
            This represents the hypothetical "ground truth" distribution over
            quarters in which AGI might actually be developed:
        </p>
        <div id="ground-truth-widget"></div>
        <p>
            The ground truth distribution has a total mass of 85%, with a peak
            in Q3 of 2035, indicating a later and more conservative timeline
            compared to our estimates.
        </p>
    </div>

    <p>
        Ut leo augue, fermentum sed nisi non, tempus mattis elit. Praesent eu
        ipsum ac arcu porttitor consequat a at tellus. Praesent non volutpat
        orci, a sollicitudin justo. Suspendisse potenti. Nullam facilisis nunc
        non magna vehicula, at pulvinar odio feugiat. Nam rhoncus nunc nec
        libero suscipit viverra. Mauris dui ante, porta quis tellus at,
        consequat convallis sapien. Vivamus eu enim ut felis facilisis porta
        vel quis leo. Suspendisse varius molestie tristique.
    </p>

    <div class="reference-section" style="background: #f8f9fa; border-color: #dee2e6;">
        <h2 style="color: #495057; border-bottom-color: #dee2e6;">Discrete
        Bayesian Analysis</h2>
        <p>
            This section compares how well each distribution predicted the
            ground truth using discrete Bayesian logic. We calculate the
            likelihood of observing the ground truth given each prediction,
            then update our beliefs.
        </p>
        <div id="bayesian-analysis"></div>
    </div>


    <script type="module">
        import { createDistributionWidget } from './src/index.js';

        // Initialize widget when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            // Create initial distribution that covers the whole year range
            // from 0% at start to 100% at end
            const numPeriods = (2040 - 2026) * 4 + 1; // 14 years * 4 quarters + 1 = 57 quarters
            const initialDistribution = Array(numPeriods).fill(0).map((_, i) => i / (numPeriods - 1));

            // Create reference distribution (bell curve shape)
            const referenceDistribution = Array(numPeriods).fill(0).map((_, i) => {
                const center = numPeriods / 2;
                const sigma = numPeriods / 6;
                const x = (i - center) / sigma;
                return Math.exp(-(x * x) / 2);
            });

            const widget = createDistributionWidget('distribution-widget', {
                height: 500,
                startYear: 2026,
                endYear: 2040,
                initialDistribution: initialDistribution,
                totalMass: 50
            });

            // Create reference widget with green gradient
            const referenceWidget = createDistributionWidget('reference-widget', {
                height: 500,
                startYear: 2026,
                endYear: 2040,
                initialDistribution: referenceDistribution,
                totalMass: 75,
                color: 'green',
                interactive: false
            });

            // Create ground truth distribution (later peak, red color)
            const groundTruthDistribution = Array(numPeriods).fill(0).map((_, i) => {
                const center = numPeriods * 0.7; // Later peak (around 2035)
                const sigma = numPeriods / 8; // Slightly wider spread
                const x = (i - center) / sigma;
                return Math.exp(-(x * x) / 2);
            });

            // Create ground truth widget with red gradient
            const groundTruthWidget = createDistributionWidget('ground-truth-widget', {
                height: 500,
                startYear: 2026,
                endYear: 2040,
                initialDistribution: groundTruthDistribution,
                totalMass: 85,
                color: 'red',
                interactive: false
            });

            // Handle total mass input changes with intelligent validation
            const totalMassInput = document.getElementById('total-mass');
            const inputFeedback = document.getElementById('input-feedback');

            // Debounce function to avoid excessive updates
            let debounceTimer;

            function updateWidget(value) {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    widget.setTotalMass(value);
                    updateBayesianAnalysis(); // Update analysis when total mass changes
                }, 100);
            }

            function validateAndUpdateInput() {
                const inputValue = totalMassInput.value.trim();
                const feedback = inputFeedback;

                // Clear previous styling
                totalMassInput.classList.remove('valid', 'invalid');
                feedback.className = 'input-feedback';
                feedback.textContent = '';

                // Handle empty input
                if (inputValue === '') {
                    totalMassInput.classList.add('invalid');
                    feedback.classList.add('error');
                    feedback.textContent = '0-100 only';
                    return;
                }

                // Check if input contains only digits
                if (!/^\d+$/.test(inputValue)) {
                    totalMassInput.classList.add('invalid');
                    feedback.classList.add('error');
                    feedback.textContent = 'Numbers only';
                    return;
                }

                const numValue = parseInt(inputValue, 10);

                // Check range
                if (numValue < 0 || numValue > 100) {
                    totalMassInput.classList.add('invalid');
                    feedback.classList.add('error');
                    feedback.textContent = '0-100 only';
                    return;
                }

                // Valid input
                totalMassInput.classList.add('valid');
                feedback.classList.add('success');

                // Update widget with valid value
                updateWidget(numValue);
            }

            // Handle input events
            totalMassInput.addEventListener('input', validateAndUpdateInput);
            totalMassInput.addEventListener('blur', () => {
                // On blur, ensure we have a valid number
                const inputValue = totalMassInput.value.trim();
                if (inputValue === '') {
                    totalMassInput.value = '50';
                    validateAndUpdateInput();
                } else if (/^\d+$/.test(inputValue)) {
                    const numValue = parseInt(inputValue, 10);
                    if (numValue >= 0 && numValue <= 100) {
                        // Ensure clean formatting (remove leading zeros)
                        totalMassInput.value = numValue.toString();
                        validateAndUpdateInput();
                    }
                }
            });

            // Handle keydown for better UX
            totalMassInput.addEventListener('keydown', (e) => {
                // Allow: backspace, delete, tab, escape, enter, and navigation keys
                if ([8, 9, 27, 13, 46, 37, 38, 39, 40].includes(e.keyCode)) {
                    return;
                }

                // Allow digits only
                if (e.keyCode >= 48 && e.keyCode <= 57) {
                    return;
                }

                // Allow numpad digits
                if (e.keyCode >= 96 && e.keyCode <= 105) {
                    return;
                }

                // Prevent other keys
                e.preventDefault();
            });

            // Initialize with current value
            validateAndUpdateInput();

            // Bayesian analysis functions - Simplified Log Score
            function calculateLogScore(prediction, groundTruth) {
                if (prediction.length !== groundTruth.length) {
                    throw new Error('Distributions must have the same length');
                }

                // Calculate total masses
                const predictionMass = prediction.reduce((sum, p) => sum + p, 0);
                const groundTruthMass = groundTruth.reduce((sum, p) => sum + p, 0);

                if (predictionMass === 0 || groundTruthMass === 0) {
                    throw new Error('Distributions cannot have zero total mass');
                }

                // Normalize distributions
                const normalizedPrediction = prediction.map(p => p / predictionMass);
                const normalizedGroundTruth = groundTruth.map(p => p / groundTruthMass);

                // Calculate KL divergence: KL(groundTruth || prediction)
                const epsilon = 1e-10;
                let klDivergence = 0;

                for (let i = 0; i < normalizedGroundTruth.length; i++) {
                    const p = normalizedGroundTruth[i];
                    const q = normalizedPrediction[i];

                    if (p > epsilon && q > epsilon) {
                        klDivergence += p * Math.log(p / q);
                    } else if (p > epsilon && q <= epsilon) {
                        // Ground truth has mass where prediction has none - infinite penalty
                        return Infinity;
                    }
                }

                // Add log mass terms for proper handling of unnormalized distributions
                const logScore = klDivergence - Math.log(groundTruthMass) + Math.log(predictionMass);

                return logScore;
            }

            function comparePredictions(prediction1, prediction2, groundTruth) {
                const score1 = calculateLogScore(prediction1, groundTruth);
                const score2 = calculateLogScore(prediction2, groundTruth);

                const winner = score1 < score2 ? 'prediction1' : 'prediction2';

                // Handle special cases
                let improvement;
                if (score1 === Infinity && score2 === Infinity) {
                    // Both predictions are equally bad (both have infinite penalty)
                    improvement = 0;
                } else if (score1 === Infinity) {
                    // prediction1 has infinite penalty, prediction2 wins
                    improvement = 100;
                } else if (score2 === Infinity) {
                    // prediction2 has infinite penalty, prediction1 wins
                    improvement = 100;
                } else if (Math.abs(score1 - score2) < 1e-10 || Math.max(score1, score2) === 0) {
                    // Scores are very close or both are 0
                    improvement = 0;
                } else {
                    // Normal case: calculate percentage improvement
                    improvement = Math.abs(score1 - score2) / Math.max(score1, score2) * 100;
                    // Ensure improvement is finite
                    if (!isFinite(improvement)) {
                        improvement = 0;
                    }
                }

                return {
                    prediction1: { logScore: score1 },
                    prediction2: { logScore: score2 },
                    winner,
                    improvement: improvement.toFixed(1)
                };
            }

            function updateBayesianAnalysis() {
                const analysisContainer = document.getElementById('bayesian-analysis');

                try {
                    // Get current distributions
                    const referenceDist = referenceWidget.getDistribution();
                    const interactiveDist = widget.getDistribution();
                    const groundTruthDist = groundTruthWidget.getDistribution();

                    // Scale distributions to their total masses (for display purposes)
                    const referenceMass = 75;
                    const interactiveMass = parseInt(document.getElementById('total-mass').value) || 50;
                    const groundTruthMass = 85;

                    const scaledReference = referenceDist.map(p => p * referenceMass / 100);
                    const scaledInteractive = interactiveDist.map(p => p * interactiveMass / 100);
                    const scaledGroundTruth = groundTruthDist.map(p => p * groundTruthMass / 100);

                    // Calculate log scores
                    const referenceScore = calculateLogScore(scaledReference, scaledGroundTruth);
                    const interactiveScore = calculateLogScore(scaledInteractive, scaledGroundTruth);

                    // Compare predictions
                    const comparison = comparePredictions(scaledReference, scaledInteractive, scaledGroundTruth);

                    // Determine winner
                    const winner = comparison.winner === 'prediction1' ? 'Our AGI Timelines' : 'Your AGI Timelines';
                    const improvement = comparison.improvement;

                    // Create analysis HTML
                    const analysisHTML = `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                            <div style="background: white; padding: 20px; border-radius: 8px; border: 2px solid #dee2e6;">
                                <h3 style="color: #28a745; margin-top: 0;">Our AGI Timelines</h3>
                                <p><strong>Log Score:</strong> ${referenceScore.toFixed(6)}</p>
                                <p><strong>Total Mass:</strong> ${referenceMass}%</p>
                                <p><strong>Interpretation:</strong> ${referenceScore === Infinity ? 'Infinite penalty (zero mass where ground truth has mass)' : 
                                    referenceScore === 0 ? 'Perfect prediction' : 
                                    referenceScore < 0.1 ? 'Excellent prediction' :
                                    referenceScore < 0.5 ? 'Good prediction' :
                                    referenceScore < 1.0 ? 'Fair prediction' : 'Poor prediction'}</p>
                            </div>
                            <div style="background: white; padding: 20px; border-radius: 8px; border: 2px solid #dee2e6;">
                                <h3 style="color: #007bff; margin-top: 0;">Your AGI Timelines</h3>
                                <p><strong>Log Score:</strong> ${interactiveScore.toFixed(6)}</p>
                                <p><strong>Total Mass:</strong> ${interactiveMass}%</p>
                                <p><strong>Interpretation:</strong> ${interactiveScore === Infinity ? 'Infinite penalty (zero mass where ground truth has mass)' : 
                                    interactiveScore === 0 ? 'Perfect prediction' : 
                                    interactiveScore < 0.1 ? 'Excellent prediction' :
                                    interactiveScore < 0.5 ? 'Good prediction' :
                                    interactiveScore < 1.0 ? 'Fair prediction' : 'Poor prediction'}</p>
                            </div>
                        </div>
                        <div style="background: white; padding: 20px; border-radius: 8px; border: 2px solid #dee2e6; margin-top: 20px;">
                            <h3 style="color: #495057; margin-top: 0;">Analysis Results</h3>
                            <p><strong>Winner:</strong> <span style="color: ${winner.includes('Our') ? '#28a745' : '#007bff'}; font-weight: bold;">${winner}</span></p>
                            <p><strong>Improvement:</strong> ${improvement}% better than the alternative</p>
                            <p><strong>Interpretation:</strong> The ${winner.toLowerCase()} distribution more accurately predicted the ground truth. 
                            Lower log scores indicate better predictions. The log score properly handles unnormalized distributions 
                            and penalizes both shape differences and mass differences.</p>
                        </div>

                    `;

                    analysisContainer.innerHTML = analysisHTML;
                } catch (error) {
                    console.error('Error in Bayesian analysis:', error);
                    analysisContainer.innerHTML = `
                        <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 8px; color: #856404;">
                            <strong>Analysis Error:</strong> Unable to perform Bayesian analysis. Please try refreshing the page.
                        </div>
                    `;
                }
            }

            // Update Bayesian analysis when distribution changes
            widget.setOnChange(updateBayesianAnalysis);

            // Initial analysis
            updateBayesianAnalysis();
        });
    </script>
</body>
</html>
