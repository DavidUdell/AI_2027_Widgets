<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 2027 Widgets Demo</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            max-width: 1000px;
            margin: 0 auto;
            padding: 5px;
            color: #333;
        }

        h1 {
            color: #2c3e50;
            border-bottom: 2px solid #2a623d;
            padding-bottom: 10px;
        }

        h2 {
            color: #2c3e50;
            margin-top: 40px;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .widget-container {
            display: block;
            text-align: center;
            margin: 20px auto;
            padding: 5px;
            width: 100%;
            min-height: 600px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #fffff8;
            box-sizing: border-box;
        }

        .widget-container h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #2c3e50;
            font-size: 20px;
        }

        .widget-container h2 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #2c3e50;
            border-bottom: 2px solid #2c3e50;
            padding-bottom: 10px;
            font-size: 24px;
            text-align: left;
        }

        .widget-container p {
            text-align: left;
        }

        .widget-canvas {
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #f8f9fa;
            cursor: crosshair;
            max-width: 100%;
            display: block;
            margin: 0 auto;
            touch-action: none;
        }

        .instructions {
            background: #fffff8;
            border-left: 4px solid #2a623d;
            padding: 12px;
            margin: 20px 0;
            border-radius: 4px;
        }

        /* Visibility toggle styles */
        .visibility-toggle {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .visibility-toggle input[type="checkbox"] {
            margin: 0;
            cursor: pointer;
            accent-color: #495057;
        }

        .visibility-toggle input[type="checkbox"]:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }

        .visibility-toggle .color-box {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            border: 1px solid #ccc;
        }

        .visibility-toggle .label {
            font-size: 12px;
            font-weight: 500;
            color: #495057;
        }

    </style>
</head>
<body>
    <h1>AI 2027 Widgets Demo</h1>

    <p>
        Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod
        tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim
        veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea
        commodo consequat.
    </p>

    <p>
        Duis aute irure dolor in reprehenderit in voluptate velit esse cillum
        dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non
        proident, sunt in culpa qui officia deserunt mollit anim id est
        laborum.
    </p>

    <p>
        Sed ut perspiciatis unde omnis iste natus error sit voluptatem
        accusantium doloremque laudantium, totam rem aperiam, eaque ipsa quae
        ab illo inventore veritatis et quasi architecto beatae vitae dicta sunt
        explicabo.
    </p>

    <p>
        Nemo enim ipsam voluptatem quia voluptas sit aspernatur aut odit aut
        fugit, sed quia consequuntur magni dolores eos qui ratione voluptatem
        sequi nesciunt. Neque porro quisquam est, qui dolorem ipsum quia dolor
        sit amet, consectetur, adipisci velit, sed quia non numquam eius modi
        tempora incidunt ut labore et dolore magnam aliquam quaerat voluptatem.
    </p>

    <div class="widget-container">
        <h2>AGI Timelines</h2>

        <!-- Distribution Controls -->
        <div style="margin-bottom: 20px; text-align: center;">
            <div style="display: flex; justify-content: center; align-items:
            center; gap: 15px; flex-wrap: wrap;">
                <!-- Color Selection -->
                <div style="display: flex; align-items: center; gap: 8px;">
                    <label for="distribution-color" style="font-weight:
                    bold;">Drawing:</label>
                    <select id="distribution-color" style="padding: 4px 8px;
                    border: 1px solid #ccc; border-radius: 4px; font-size:
                    14px;">
                        <option value="blue">Blue</option>
                        <option value="green">Green</option>
                        <option value="red">Red</option>
                        <option value="purple">Purple</option>
                        <option value="orange">Orange</option>
                        <option value="yellow">Yellow</option>
                    </select>
                </div>
                
                <!-- Visibility Toggles -->
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span style="font-weight: bold;">Background:</span>
                    <div id="visibility-toggles" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; width: 300px;">
                        <!-- Checkboxes will be added here dynamically -->
                    </div>
                </div>

            </div>
        </div>

        <div id="interactive-widget"></div>
        <div style="margin-top: 50px;">
            <div class="instructions">
                <strong>Note:</strong> <i>Lower</i> values indicate better
                agreement, with 0.00 being perfect agreement.
            </div>
            <div id="calculator-widget"></div>
        </div>

    </div>

    <p>
        Ut enim ad minima veniam, quis nostrum exercitationem ullam corporis
        suscipit laboriosam, nisi ut aliquid ex ea commodi consequatur? Quis
        autem vel eum iure reprehenderit qui in ea voluptate velit esse quam
        nihil molestiae consequatur, vel illum qui dolorem eum fugiat quo
        voluptas nulla pariatur?
    </p>

    <p>
        Vivamus congue mauris neque, sollicitudin porttitor ipsum tempus
        eleifend. Interdum et malesuada fames ac ante ipsum primis in faucibus.
        Mauris molestie sodales commodo. Nunc ultrices mauris magna, non
        condimentum tellus varius a. Praesent hendrerit, massa ac iaculis
        scelerisque, risus est maximus risus, sed pulvinar quam lorem at metus.
        Curabitur ante diam, laoreet laoreet auctor non, sollicitudin ac velit.
        Quisque pretium nunc magna, ac ornare purus pharetra eget. Orci varius
        natoque penatibus et magnis dis parturient montes, nascetur ridiculus
        mus. Nullam in arcu pellentesque, finibus tellus varius, facilisis
        dolor. Curabitur tempor felis vitae turpis tristique vehicula. Praesent
        quis magna in metus mattis imperdiet et rutrum libero. Morbi leo dui,
        rutrum eget cursus eu, rhoncus vel diam. Aenean molestie pharetra
        imperdiet. Quisque ultrices, enim sit amet viverra efficitur, tellus
        augue interdum odio, in viverra augue eros sit amet tellus.
    </p>

    <p>
        Quisque vel aliquet ex. Donec dui lacus, faucibus a nisi id, vulputate
        sagittis lorem. Aenean pretium purus in lacus scelerisque luctus.
        Pellentesque efficitur in magna in malesuada. Nunc vestibulum interdum
        nunc eget dictum. Mauris ullamcorper, diam ut pretium tincidunt, diam
        mi tempus dui, id scelerisque turpis augue id dui. Donec euismod, leo
        porta ultrices dictum, augue nibh rhoncus quam, ac volutpat odio ante
        id augue.
    </p>

    <p>
        Curabitur venenatis, leo sit amet consequat porta, odio turpis
        tincidunt ligula, condimentum auctor lacus velit ut lectus. Sed in
        massa non justo fringilla rhoncus dapibus quis est. Donec tincidunt
        magna turpis, ac condimentum purus vulputate et. Pellentesque risus
        nisi, pulvinar ut rhoncus sit amet, interdum at felis. Fusce ligula
        massa, ornare nec ultrices vel, fermentum varius metus. Fusce sed
        placerat erat. Pellentesque habitant morbi tristique senectus et netus
        et malesuada fames ac turpis egestas. Maecenas tortor eros, maximus non
        tincidunt nec, accumsan et nunc. Mauris velit nisl, venenatis vel
        fermentum ut, gravida et odio. Donec et auctor eros, vitae scelerisque
        augue. Sed euismod tellus vel urna hendrerit, vitae vulputate augue
        venenatis. Nunc rhoncus, massa a facilisis egestas, ligula felis rutrum
        lorem, a egestas nisl nisi sed enim. Fusce non dapibus elit, nec
        consequat augue.        
    </p>

    <p>
        Ut leo augue, fermentum sed nisi non, tempus mattis elit. Praesent eu
        ipsum ac arcu porttitor consequat a at tellus. Praesent non volutpat
        orci, a sollicitudin justo. Suspendisse potenti. Nullam facilisis nunc
        non magna vehicula, at pulvinar odio feugiat. Nam rhoncus nunc nec
        libero suscipit viverra. Mauris dui ante, porta quis tellus at,
        consequat convallis sapien. Vivamus eu enim ut felis facilisis porta
        vel quis leo. Suspendisse varius molestie tristique.
    </p>

    <script>
    var AI2027Widgets=function(Q){"use strict";function be(C,d){const V=document.getElementById(C);if(!V){console.error(`Container with ID '${C}' not found`);return}function E(){return window.innerWidth<500?.75:1}const I=d.enableUrlState!==!1,f=document.createElement("canvas");let p=V.getBoundingClientRect().width;f.width=p;const c=500;f.height=c,f.className="widget-canvas";const e=f.getContext("2d"),m=2026,G=2040-m+1,S=(G-1)*4+1;let o=[],u=0;const M={};let z={},k={},v=!1,B=0,W=0,$=!1,R=0,U=1,H=!1,Y=0,O=0,a=70,j=p-2*a,P=c-2*a,_=j/(S-1);function ve(){if(!I)return;const t=`d=${o.map(i=>{const l=Se(i.values);return`${i.color}:${l}`}).join(",")}`;if(window.history&&window.history.replaceState){const i=window.location.pathname+window.location.search+"#"+t;window.history.replaceState(null,"",i)}}function Se(r){return r.map(i=>Math.round(Math.max(q,i)*1e3)).map(i=>i.toString(36).toUpperCase().padStart(2,"0")).join("")}function we(r){if(!r||typeof r!="string"||r.length===0)return null;const t=2;if(r.length%t!==0)return null;const i=[];for(let l=0;l<r.length;l+=t)i.push(r.slice(l,l+t));try{const l=i.map(n=>{if(!/^[0-9A-Za-z]{2}$/.test(n))throw new Error(`Invalid chunk format: ${n}`);const s=parseInt(n.toUpperCase(),36);if(isNaN(s)||s<0||s>1e3)throw new Error(`Invalid value: ${s} from chunk ${n}`);return Math.max(q,s/1e3)});for(let n=0;n<l.length;n++)if(l[n]<0||l[n]>1)throw new Error(`Invalid probability value: ${l[n]} at index ${n}`);return l}catch(l){return console.warn("Failed to decode distribution values:",l.message),null}}function oe(){if(!I)return!1;const r=window.location.hash.substring(1);if(!r)return!1;try{const i=new URLSearchParams(r).get("d");if(i){const l=i.split(","),n=[];let s=!1;for(const x of l){const[h,D]=x.split(":");if(!h||!D){console.warn("Invalid distribution format:",x),s=!0;break}if(!["blue","green","red","purple","orange","yellow"].includes(h)){console.warn("Invalid distribution color:",h),s=!0;break}const T=we(D);if(T===null){console.warn("Failed to decode distribution values for color:",h),s=!0;break}if(T.length!==S){console.warn(`Invalid number of values for ${h}: expected ${S}, got ${T.length}`),s=!0;break}if(n.some(w=>w.color===h)){console.warn("Duplicate distribution color:",h),s=!0;break}n.push({color:h,values:T})}if(s)return console.warn("Invalid distributions detected, falling back to initialization state"),!1;const g=["blue","green","red","purple","orange","yellow"],b=n.map(x=>x.color),y=g.filter(x=>!b.includes(x));if(y.length>0&&(console.warn(`Missing colors: ${y.join(", ")}. Filling with default values.`),y.forEach(x=>{const h=Array(S).fill(0).map((D,L)=>.2+.8*L/(S-1));n.push({color:x,values:h})})),n.length>0)return o=n,o.forEach((x,h)=>{z[h]=[...x.values]}),u=0,U=1,H=!1,o.forEach((x,h)=>{M[h]=h===0}),!0}return!1}catch(t){return console.warn("Failed to parse URL state:",t),!1}}function ke(){if(!I)return;oe()||De(),o.length>0&&u>=0&&N(),window.addEventListener("hashchange",()=>{oe()&&(N(),F(),d.onChange&&d.onChange(o))})}function De(){["blue","green","red","purple","orange","yellow"].forEach((t,i)=>{const l=Array(S).fill(0).map((n,s)=>.2+.8*s/(S-1));o.push({color:t,values:l}),z[i]=[...l]})}let te=null;function X(){te&&clearTimeout(te),te=setTimeout(()=>{ve()},500)}function ne(){const t=V.getBoundingClientRect().width;t!==p&&(p=t,f.width=p,a=70,j=p-2*a,P=c-2*a,_=j/(S-1)),F()}new ResizeObserver(()=>{ne()}).observe(V);const Ce=()=>ne();window.addEventListener("resize",Ce);const ie={blue:{primary:"#007bff",gradientStart:"rgba(0, 123, 255, 0.3)",gradientEnd:"rgba(0, 123, 255, 0.1)",stroke:"#007bff"},green:{primary:"#28a745",gradientStart:"rgba(40, 167, 69, 0.3)",gradientEnd:"rgba(40, 167, 69, 0.1)",stroke:"#28a745"},red:{primary:"#dc3545",gradientStart:"rgba(220, 53, 69, 0.3)",gradientEnd:"rgba(220, 53, 69, 0.1)",stroke:"#dc3545"},purple:{primary:"#6f42c1",gradientStart:"rgba(111, 66, 193, 0.3)",gradientEnd:"rgba(111, 66, 193, 0.1)",stroke:"#6f42c1"},orange:{primary:"#fd7e14",gradientStart:"rgba(253, 126, 20, 0.3)",gradientEnd:"rgba(253, 126, 20, 0.1)",stroke:"#fd7e14"},yellow:{primary:"#ffc107",gradientStart:"rgba(255, 193, 7, 0.3)",gradientEnd:"rgba(255, 193, 7, 0.1)",stroke:"#ffc107"}};function Me(){o.forEach((r,t)=>{M[t]=t===u})}const q=1e-6;function ae(r,t){const i=Math.round((r-a)/_),l=Math.max(0,Math.min(S-1,i)),n=1-(t-a)/P,s=Math.max(q,Math.min(1,n));return{periodIndex:l,probability:s}}function se(r,t){const i=a+r*_,l=a+(1-t)*P;return{x:i,y:l}}function F(){e.fillStyle="#f8f9fa",e.fillRect(0,0,p,c),Pe(),Te(),Ie(),Ae()}function J(r){const t=r.values.reduce((l,n)=>l+n,0),i=t>0?100/t:0;return Math.max(...r.values)*i}function Ee(r){if(r<0||r>=o.length)return;const t=o[r],i=Math.max(...t.values);if(i<=0)return;const n=P/P;if(i>n){const s=n/i;U=s,o.forEach((g,b)=>{for(let y=0;y<g.values.length;y++)g.values[y]*=s}),R=a+(1-n)*P,H=!1}else U=1,H=!1}function N(){if(u>=0&&u<o.length){const r=o[u],t=Math.max(...r.values);if(!H)R=a+(1-t)*P;else{const i=1-(R-a)/P;Math.abs(i-t)>.01&&(R=a+(1-t)*P)}}}function Pe(){const r=o.map((s,g)=>({dist:s,index:g})).filter(({index:s})=>M[s]&&s!==u);if(r.length===0){Y=0,O=0;return}let t=0;if(u>=0&&u<o.length){const s=o[u];t=J(s)}const l=r.map(({dist:s})=>{const g=Math.max(...s.values),b=J(s);return{maxValue:g,normalizedPeak:b}}).filter(s=>s.normalizedPeak<t);if(l.length===0){Y=0,O=0;return}l.sort((s,g)=>g.normalizedPeak-s.normalizedPeak);const n=l[0];n?(Y=a+(1-n.maxValue)*P,O=n.normalizedPeak):(Y=0,O=0)}function ce(r,t){const i="9.99%";e.font="12px -apple-system, BlinkMacSystemFont, sans-serif";const n=e.measureText(i).width+8,s=16,g=a-5-n;return r>=g&&r<=a-5&&t>=R-s/2&&t<=R+s/2}function Te(){if(e.strokeStyle="#dee2e6",e.lineWidth=1,e.beginPath(),e.rect(a,a,j,P),e.stroke(),u>=0&&u<o.length){const t=o[u];if(t.values.reduce((l,n)=>l+n,0)>0&&J(t)>0){const n=R,s=ie[t.color];$?(e.strokeStyle=s.stroke,e.lineWidth=2):(e.strokeStyle="#adb5bd",e.lineWidth=1),e.setLineDash([3,3]),e.beginPath(),e.moveTo(a,n),e.lineTo(p-a,n),e.stroke(),e.setLineDash([]);const g=w=>w<10?w.toFixed(2)+"%":Math.round(w)+"%",b=J(t);e.fillStyle=$?s.stroke:"#495057",e.font="12px -apple-system, BlinkMacSystemFont, sans-serif",e.textAlign="center",e.textBaseline="middle";const y=g(b),h=e.measureText(y).width+8,D=16,L=a-5-h,T=n-D/2;if($){const w=s.stroke.replace("#",""),re=parseInt(w.substr(0,2),16),K=parseInt(w.substr(2,2),16),le=parseInt(w.substr(4,2),16);e.fillStyle=`rgba(${re}, ${K}, ${le}, 0.1)`}else e.fillStyle="rgba(73, 80, 87, 0.1)";e.fillRect(L,T,h,D),e.strokeStyle=$?s.stroke:"#495057",e.lineWidth=1,e.strokeRect(L,T,h,D),e.fillStyle=$?s.stroke:"#495057",e.fillText(y,L+h/2,n)}}if(o.forEach((t,i)=>{if(!M[i])return;const l=t.values.reduce((n,s)=>n+s,0);if(l>0){const n=l/2;let s=0,g=0;for(let ee=0;ee<t.values.length;ee++)if(s+=t.values[ee],s>=n){g=ee;break}const b=se(g,0).x,y=ie[t.color],x=y.stroke.replace("#",""),h=parseInt(x.substr(0,2),16),D=parseInt(x.substr(2,2),16),L=parseInt(x.substr(4,2),16);e.strokeStyle=`rgba(${h}, ${D}, ${L}, 0.7)`,e.lineWidth=1,e.setLineDash([5,5]),e.beginPath(),e.moveTo(b,a),e.lineTo(b,c-a),e.stroke(),e.setLineDash([]);const T=m+Math.floor(g/4),w=g%4+1,re=T.toString().slice(-2);e.fillStyle=y.stroke,e.font=`${Math.round(12*E())}px -apple-system, BlinkMacSystemFont, sans-serif`,e.textAlign="center",e.textBaseline="bottom";const K=a-10,le=K-14,ge="’",he=re,Le=e.measureText(ge).width,pe=e.measureText(he).width,me=Le+pe;e.textAlign="left",e.fillText(ge,b-me/2,K),e.fillText(he,b+me/2-pe,K),e.textAlign="center",e.fillText(`Q${w}`,b,le)}}),e.fillStyle="#495057",e.font="12px -apple-system, BlinkMacSystemFont, sans-serif",e.textAlign="center",e.textBaseline="bottom",e.fillText("Medians",p/2,a-35),u>=0&&u<o.length&&o[u].values.reduce((t,i)=>t+i,0)>0){const t=o[u],i=Math.max(...t.values),l=Math.abs(i-q)<1e-10,n=U<.1;!l&&!n&&(e.fillStyle="#495057",e.font="12px -apple-system, BlinkMacSystemFont, sans-serif",e.textAlign="right",e.textBaseline="middle",e.fillText("ε%",a-10,c-a))}else e.fillStyle="#495057",e.font="12px -apple-system, BlinkMacSystemFont, sans-serif",e.textAlign="right",e.textBaseline="middle",e.fillText("ε%",a-10,c-a);if(Y>0&&O>0){e.strokeStyle="#adb5bd",e.lineWidth=1,e.setLineDash([3,3]),e.beginPath(),e.moveTo(a,Y),e.lineTo(p-a,Y),e.stroke(),e.setLineDash([]);const t=n=>n<10?n.toFixed(2)+"%":Math.round(n)+"%";e.fillStyle="#6c757d",e.font="12px -apple-system, BlinkMacSystemFont, sans-serif",e.textAlign="left",e.textBaseline="middle";const i=t(O),l=p-a+5;e.fillText(i,l,Y)}}function Ie(){e.fillStyle="#495057",e.font=`${Math.round(12*E())}px -apple-system, BlinkMacSystemFont, sans-serif`,e.textAlign="center",e.textBaseline="middle";const r=E()<1;for(let t=0;t<G;t++){if(r&&t>0&&t<G-1&&t%2===1)continue;let i;t===G-1?i=a+(S-1)*_:i=a+t*4*_;const l=m+t;if(t===G-1){const n=[">2039","or AGI never"],g=c-a/2-18;n.forEach((b,y)=>{e.fillText(b,i,g+y*14)})}else if(t===0)e.fillText(l.toString(),i,c-a/2-18);else{const n=l.toString().slice(-2);e.fillText(`’${n}`,i,c-a/2-18)}}e.fillStyle="#495057",e.font="bold 16px -apple-system, BlinkMacSystemFont, sans-serif",e.textAlign="center",e.textBaseline="top",e.fillText("Quarters",p/2,c-a/2+7),e.save(),e.translate(a/2-22,c/2),e.rotate(-Math.PI/2),e.fillStyle="#495057",e.font="bold 16px -apple-system, BlinkMacSystemFont, sans-serif",e.textAlign="center",e.textBaseline="middle",e.fillText("AGI Invented In",0,0),e.restore()}function Ae(){if(o.forEach((r,t)=>{t!==u&&M[t]&&ue(r,!1)}),u>=0&&u<o.length&&M[u]){const r=o[u];ue(r,!0)}}function ue(r,t){const i=ie[r.color];if(!i)return;e.save(),e.beginPath(),e.rect(a,a,j,P),e.clip();const l=e.createLinearGradient(a,a,a,c-a);if(t)l.addColorStop(0,i.gradientStart),l.addColorStop(1,i.gradientEnd);else{const n=i.gradientStart.replace("0.3)","0.15)"),s=i.gradientEnd.replace("0.1)","0.05)");l.addColorStop(0,n),l.addColorStop(1,s)}e.fillStyle=l,e.beginPath(),e.moveTo(a,c-a);for(let n=0;n<S;n++){const s=se(n,r.values[n]);e.lineTo(s.x,s.y)}if(e.lineTo(p-a,c-a),e.closePath(),e.fill(),t)e.strokeStyle=i.stroke,e.lineWidth=2;else{const n=i.stroke.replace("#",""),s=parseInt(n.substr(0,2),16),g=parseInt(n.substr(2,2),16),b=parseInt(n.substr(4,2),16);e.strokeStyle=`rgba(${s}, ${g}, ${b}, 0.5)`,e.lineWidth=1.5}e.beginPath();for(let n=0;n<S;n++){const s=se(n,r.values[n]);n===0?e.moveTo(s.x,s.y):e.lineTo(s.x,s.y)}e.stroke(),e.restore()}function Be(r){const t=f.getBoundingClientRect(),i=r.clientX-t.left,l=r.clientY-t.top;if(ce(i,l)){$=!0,H=!0,f.style.cursor="ns-resize",F();return}v=!0,B=i,W=l,H=!1;const{periodIndex:n,probability:s}=ae(i,l);o[u].values[n]=s,k[u]=!0,N(),F(),d.onChange&&d.onChange(o),X()}function Fe(r){const t=f.getBoundingClientRect(),i=r.clientX-t.left,l=r.clientY-t.top;if(!$&&!v&&(ce(i,l)?f.style.cursor="ns-resize":f.style.cursor="crosshair"),$){const b=Math.max(a,Math.min(c-a,l));if(R=b,u>=0&&u<o.length){const y=o[u],x=Math.max(...y.values),h=1-(b-a)/P;U=Math.max(q,h/x),o.forEach((D,L)=>{const T=[...D.values];for(let w=0;w<D.values.length;w++)D.values[w]=T[w]*U})}F(),d.onChange&&d.onChange(o),X();return}if(!v)return;const n=i-B,s=l-W,g=Math.sqrt(n*n+s*s);if(g>2){const b=Math.ceil(g/2);for(let y=0;y<=b;y++){const x=y/b,h=B+n*x,D=W+s*x,{periodIndex:L,probability:T}=ae(h,D);o[u].values[L]=T,k[u]=!0}B=i,W=l,N(),F(),d.onChange&&d.onChange(o),X()}}function de(){$&&($=!1,f.style.cursor="crosshair",F()),v&&(fe(),u>=0&&u<o.length&&(z[u]=[...o[u].values]),N(),X()),v=!1}function fe(){const t=o[u].values.reduce((i,l)=>i+l,0);t<=0||(o.forEach((i,l)=>{if(l!==u){const n=i.values.reduce((s,g)=>s+g,0);if(n>0){const s=t/n;for(let g=0;g<i.values.length;g++)i.values[g]*=s}}}),F(),d.onChange&&d.onChange(o),X())}return f.addEventListener("pointerdown",Be),f.addEventListener("pointermove",Fe),f.addEventListener("pointerup",de),f.addEventListener("pointerleave",de),f.addEventListener("contextmenu",r=>r.preventDefault()),f.addEventListener("touchstart",r=>r.preventDefault(),{passive:!1}),f.addEventListener("touchmove",r=>r.preventDefault(),{passive:!1}),V.appendChild(f),ke(),Me(),N(),F(),{setActiveDistributionByColor:r=>{const t=o.findIndex(i=>i.color===r);t<0||(u=t,U=1,H=!1,o.forEach((i,l)=>{z[l]&&!k[l]&&(i.values=[...z[l]])}),ne(),Ee(t),N(),M[t]=!0,fe(),X())},getDistributions:()=>[...o],getActiveDistributionIndex:()=>u,setOnChange:r=>{d.onChange=r},setDistributionVisibility:(r,t)=>{M.hasOwnProperty(r)&&(M[r]=t,F())},getDistributionVisibility:r=>M[r]||!1,getVisibilityState:()=>({...M})}}function ye(C,d){if(C.length!==d.length)throw new Error("Distributions must have the same shape");if(C.length===0)throw new Error("Distributions must have at least one entry");if(C.some(c=>!Number.isFinite(c))||d.some(c=>!Number.isFinite(c)))throw new Error("Distributions must be finite");if(C.some(c=>c<-1e-12)||d.some(c=>c<-1e-12))throw new Error("Distributions cannot contain negative values");let E,I;const f=C.reduce((c,e)=>c+e,0),A=d.reduce((c,e)=>c+e,0);f<1e-12?I=C.map(c=>1/C.length):I=C.map(c=>c/f),A<1e-12?E=d.map(c=>1/d.length):E=d.map(c=>c/A);let p=0;for(let c=0;c<E.length;c++){const e=E[c],m=I[c];if(!(e<=0)){if(!(m>0))return 1/0;p+=e*Math.log(e/m)}}return p}function xe(C,d){const V=document.getElementById(C);if(!V){console.error(`Container with ID '${C}' not found`);return}const E=document.createElement("div");E.style.width="100%",E.style.fontFamily="-apple-system, BlinkMacSystemFont, sans-serif";const I=document.createElement("div");I.style.marginBottom="20px",I.style.textAlign="center";const f=document.createElement("div");f.style.display="flex",f.style.flexDirection="column",f.style.alignItems="center",f.style.gap="15px",f.style.marginBottom="15px",f.style.padding="20px",f.style.border="3px solid #2c3e50",f.style.borderRadius="8px",f.style.backgroundColor="#f8f9fa",f.style.boxShadow="0 2px 4px rgba(0,0,0,0.1)";const A=document.createElement("div");A.textContent="Kullback–Leibler Divergence",A.style.fontWeight="bold",A.style.fontSize="16px",A.style.color="#2c3e50",A.style.marginBottom="15px",A.style.textAlign="center";const p=document.createElement("div");p.style.display="flex",p.style.justifyContent="center",p.style.alignItems="center",p.style.gap="12px",p.style.marginBottom="15px";const c=document.createElement("label");c.textContent="Ground Truth:",c.style.fontWeight="bold",c.style.color="#2c3e50",c.style.fontSize="14px";const e=document.createElement("span");e.style.fontSize="14px",e.style.fontWeight="bold",e.style.color="#2c3e50",p.appendChild(c),p.appendChild(e),f.appendChild(A),f.appendChild(p);const m=document.createElement("div");m.style.marginTop="0px",m.style.padding="0px",m.style.backgroundColor="transparent",m.style.borderRadius="0px",m.style.border="none",m.style.minHeight="0px",m.style.display="none",m.style.width="100%",I.appendChild(f),f.appendChild(m),E.appendChild(I);function Z(){if(!d.distributions||d.distributions.length===0){e.textContent="None";return}const o=d.activeDistributionIndex||0;if(o>=0&&o<d.distributions.length){const u=d.distributions[o];e.textContent=u.color.charAt(0).toUpperCase()+u.color.slice(1)}else e.textContent="None"}function G(o){return Number.isFinite(o)?o.toFixed(2):"∞"}function S(){const o=d.activeDistributionIndex||0;if(m.innerHTML="",o<0||!d.distributions||d.distributions.length===0||o>=d.distributions.length){m.style.display="none";return}const u=d.distributions[o],M=d.distributions.map((k,v)=>{const B=ye(k.values,u.values);return{index:v,distribution:k,klDivergence:B}}).filter(k=>k.index===o?!1:d.visibilityState&&d.visibilityState[k.index]===!0);M.sort((k,v)=>k.klDivergence-v.klDivergence),m.style.display="block",m.style.padding="0px";const z=document.createElement("div");z.style.fontSize="14px",z.style.lineHeight="1.6",M.forEach(k=>{const v=document.createElement("div");v.style.display="flex",v.style.justifyContent="center",v.style.alignItems="center",v.style.padding="4px 0",v.style.fontFamily="monospace",v.style.fontSize="13px",v.style.gap="40px";const B=document.createElement("span");B.textContent=k.distribution.color.charAt(0).toUpperCase()+k.distribution.color.slice(1),B.style.minWidth="80px",B.style.textAlign="center";const W=document.createElement("span");W.textContent=G(k.klDivergence),W.style.minWidth="60px",W.style.textAlign="center",v.appendChild(B),v.appendChild(W),z.appendChild(v)}),m.appendChild(z)}return V.appendChild(E),Z(),m.style.display="none",{updateDistributions:o=>{d.distributions=o,Z(),S()},setActiveDistributionIndex:o=>{d.activeDistributionIndex=o,Z(),S()},setVisibilityState:o=>{d.visibilityState=o,S()}}}return Q.createCalculatorWidget=xe,Q.createInteractiveWidget=be,Object.defineProperty(Q,Symbol.toStringTag,{value:"Module"}),Q}({});
    </script>

    <script>
        const { createInteractiveWidget, createCalculatorWidget } = window.AI2027Widgets;

        // Initialize widget when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            // Create interactive widget
            const widget = createInteractiveWidget('interactive-widget', {});

            // Create calculator widget
            const calculatorWidget = createCalculatorWidget('calculator-widget', {
                distributions: widget.getDistributions(),
                activeDistributionIndex: widget.getActiveDistributionIndex(),
                visibilityState: widget.getVisibilityState()
            });

            // Interactive widget controls
            const colorSelect = document.getElementById('distribution-color');
            const visibilityTogglesContainer = document.getElementById('visibility-toggles');

            // Checkbox color labels
            const colorSchemes = {
                blue: '#007bff',
                green: '#28a745',
                red: '#dc3545',
                purple: '#6f42c1',
                orange: '#fd7e14',
                yellow: '#ffc107'
            };

            // Create visibility toggles
            function createVisibilityToggles() {
                visibilityTogglesContainer.innerHTML = '';
                const distributions = widget.getDistributions();
                const activeIndex = widget.getActiveDistributionIndex();
                const currentVisibilityState = widget.getVisibilityState();
                
                distributions.forEach((distribution, index) => {
                    const toggle = document.createElement('div');
                    toggle.className = 'visibility-toggle';
                    toggle.innerHTML = `
                        <input type="checkbox" id="toggle-${distribution.color}">
                        <div class="color-box" style="background-color: ${colorSchemes[distribution.color]}"></div>
                        <span class="label">${distribution.color.charAt(0).toUpperCase() + distribution.color.slice(1)}</span>
                    `;
                    
                    const checkbox = toggle.querySelector('input[type="checkbox"]');
                    
                    // Handle active distribution logic
                    if (index === activeIndex) {
                        // Active distribution should always be visible and disabled
                        checkbox.checked = true;
                        checkbox.disabled = true;
                        widget.setDistributionVisibility(index, true);
                    } else {
                        // Use current visibility state from widget, or default to false
                        const isVisible = currentVisibilityState[index] || false;
                        checkbox.checked = isVisible;
                        checkbox.disabled = false;
                        widget.setDistributionVisibility(index, isVisible);
                    }
                    
                    // Add event listener
                    checkbox.addEventListener('change', () => {
                        widget.setDistributionVisibility(index, checkbox.checked);
                        // Update calculator widget when visibility changes
                        if (calculatorWidget) {
                            calculatorWidget.setVisibilityState(widget.getVisibilityState());
                        }
                    });
                    
                    visibilityTogglesContainer.appendChild(toggle);
                });
            }



            // Reset visibility toggle initialization state
            function resetVisibilityToggleState() {
                const distributions = widget.getDistributions();
                distributions.forEach((distribution) => {
                    const checkbox = document.getElementById(`toggle-${distribution.color}`);
                    if (checkbox) {
                        checkbox.removeAttribute('data-initialized');
                    }
                });
            }

            // Update visibility toggles when active distribution changes
            function updateVisibilityToggles() {
                const distributions = widget.getDistributions();
                const activeIndex = widget.getActiveDistributionIndex();
                
                distributions.forEach((distribution, index) => {
                    const checkbox = document.getElementById(`toggle-${distribution.color}`);
                    if (checkbox) {
                        if (index === activeIndex) {
                            // Active distribution should always be visible and
                            // disabled
                            checkbox.checked = true;
                            checkbox.disabled = true;
                            widget.setDistributionVisibility(index, true);
                        } else {
                            // Background distributions can be toggled
                            checkbox.disabled = false;
                            // Always update the checkbox state to match the widget's visibility state
                            checkbox.checked = widget.getDistributionVisibility(index);
                            checkbox.setAttribute('data-initialized', 'true');
                        }
                    }
                });
            }

            function updateColorSelect() {
                const activeIndex = widget.getActiveDistributionIndex();
                if (activeIndex >= 0) {
                    const distributions = widget.getDistributions();
                    const activeColor = distributions[activeIndex].color;
                    colorSelect.value = activeColor;
                }
            }



            // Handle color dropdown changes
            colorSelect.addEventListener('change', () => {
                const color = colorSelect.value;
                widget.setActiveDistributionByColor(color);
                updateVisibilityToggles();
                
                // Update the calculator widget when active distribution changes
                if (calculatorWidget) {
                    calculatorWidget.setActiveDistributionIndex(widget.getActiveDistributionIndex());
                }
            });

            // Set up callback to update calculator widget when distributions
            // change
            widget.setOnChange((distributions) => {
                if (calculatorWidget) {
                    calculatorWidget.updateDistributions(distributions);
                    calculatorWidget.setActiveDistributionIndex(widget.getActiveDistributionIndex());
                    calculatorWidget.setVisibilityState(widget.getVisibilityState());
                }
                // Reset visibility toggle state to ensure proper updates
                resetVisibilityToggleState();
                // Update the UI controls to reflect the active distribution
                updateColorSelect();
                updateVisibilityToggles();
            });

            // Initialize
            createVisibilityToggles();
            updateColorSelect();
            updateVisibilityToggles();
            
            // Initialize calculator widget with current state after Interactive widget is fully set up
            if (calculatorWidget) {
                calculatorWidget.setVisibilityState(widget.getVisibilityState());
            }
            

        });
    </script>
</body>
</html>
